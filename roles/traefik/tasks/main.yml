---
- name: install traefik
  become: yes
  yum:
    name: "{{ traefik_package }}"
    state: present
  tags:
    - traefik
    - bootstrap

- name: create directory for local traefik service override
  become: yes
  file:
    dest: /etc/systemd/system/traefik.service.d
    state: directory
    mode: 0755
  tags:
    - traefik
    - bootstrap


# Kubernetes backend setup
- name: create secrets directory
  become: yes
  file:
    path: /var/run/secrets/kubernetes.io/serviceaccount/
    state: directory

- name: write secure token
  become: yes
  copy:
    src: "{{ playbook_dir }}/ssl/kubernetes/default-token"
    dest: /var/run/secrets/kubernetes.io/serviceaccount/token
  tags:
    - bootstrap
    - traefik

- name: copy k8s ca certificate
  become: yes
  copy:
    src: "{{ playbook_dir }}/ssl/kubernetes/ca.crt"
    dest: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
  tags:
    - bootstrap
    - traefik

- name: authorize k8s ca certificate
  become: yes
  copy:
    src: "{{ playbook_dir }}/ssl/kubernetes/ca.crt"
    dest: /etc/pki/ca-trust/source/anchors/ca.crt
    owner: root
    group: root
  notify:
    - update-ca-trust
  tags:
    - certificates
    - traefik

- name: create local traefik service override
  become: yes
  template:
    src: marathon.conf.j2
    dest: /etc/systemd/system/traefik.service.d/marathon.conf
    owner: root
    group: root
    mode: 0644
  notify:
    - reload systemd
    - restart traefik
  tags:
    - traefik

- name: add traefik user to tls group
  become: yes
  user:
    append: yes
    name: traefik
    groups: tls

- name: configure traefik
  become: yes
  template:
    src: traefik.toml.j2
    dest: /etc/traefik/traefik.toml
    owner: traefik
    group: traefik
    mode: 0644
    backup: yes
  notify:
    - restart traefik
  tags:
    - traefik

- name: generate traefik consul service
  become: yes
  copy:
    src: 'traefik-consul.json'
    dest: '/etc/consul/traefik.json'
  notify:
    - reload consul
  tags:
    - traefik
